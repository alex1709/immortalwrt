name: Build ImmortalWrt ER-X

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    # 1. 拉取源码
    - name: Checkout source
      uses: actions/checkout@v3

    # 2. 安装依赖
    - name: Install build deps
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3 python3-pip rsync unzip zlib1g-dev file wget

    # 3. 更新 / 安装 feeds（在使用 .config 之前执行）
    - name: Update & install feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 4. 备份 .config（不运行 make defconfig，保持你的原始配置）
    - name: Backup .config
      run: |
        cp .config .config.bak
        echo "✅ .config backed up"

    # 5. 核心包检查——缺任何关键包立即终止
    - name: Verify essentials
      run: |
        check() { grep -q "^$1=y" .config || { echo "❌ $1 missing"; exit 1; }; }
        check CONFIG_PACKAGE_luci
        check CONFIG_PACKAGE_luci-app-opkg
        check CONFIG_PACKAGE_uhttpd
        check CONFIG_PACKAGE_rpcd
        check CONFIG_PACKAGE_opkg
        check CONFIG_PACKAGE_luci-app-passwall2
        check CONFIG_PACKAGE_xray-core
        echo "✅ All essential packages present"

    # 6. 开始编译
    - name: Build firmware
      run: |
        make -j$(nproc) download
        make -j$(nproc)

    # 7. 上传产物
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_ImmortalWrt_ERX
        path: bin/targets/
